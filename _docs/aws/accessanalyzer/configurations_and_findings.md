# AWS Access Analyzer: Configuration and Findings Details

## Overview

This document provides a detailed technical breakdown of the configuration checks and finding analyses performed by the CloudSploit plugins for AWS Access Analyzer. It is intended for developers and security engineers who need to understand precisely what data is being collected and how it is interpreted.

AWS Access Analyzer works by formally analyzing policies to identify which resources, such as S3 buckets or IAM roles, are shared with an external entity. This is a critical security service for preventing unintended external access.

The CloudSploit integration consists of two main plugins:
1.  **`accessAnalyzerEnabled.js`**: A configuration check to ensure the service is active.
2.  **`accessAnalyzerActiveFindings.js`**: A findings-based check to report on active alerts from the service.

## Configuration Validation (`accessAnalyzerEnabled.js`)

This plugin acts as a foundational check to ensure that AWS Access Analyzer is properly configured and running.

-   **Goal:** To verify that an active Access Analyzer exists in each scanned region.
-   **Data Source:** The plugin uses the data collected from the `accessanalyzer:ListAnalyzers` AWS API call.
-   **Analysis Logic:** The plugin runs a check for each region and reports a failure if an active analyzer is not found. A `FAIL` (status `2`) is triggered under the following conditions:
    -   The `analyzers` array returned from the API is empty for the region.
    -   An analyzer exists, but its `status` is not `ACTIVE`.

### Logic Flowchart

```mermaid
graph TD
    A(Start) --> B{Run `ListAnalyzers` for region};
    B --> C{Analyzer found?};
    C -- No --> D[Generate FAIL: "Access Analyzer is not enabled for the region"];
    C -- Yes --> E{Analyzer status == 'ACTIVE'?};
    E -- No --> F[Generate FAIL: "Access Analyzer is not in an active state"];
    E -- Yes --> G[Generate OK: "Access Analyzer is enabled"];
    D --> H(End);
    F --> H;
    G --> H;
```

### Example Failure Finding

If a region lacks an active analyzer, the plugin will generate the following finding:

```json
{
  "status": 2,
  "message": "Access Analyzer is not enabled for the region",
  "region": "us-east-1",
  "resource": "N/A"
}
```

## Active Findings Detection (`accessAnalyzerActiveFindings.js`)

This plugin consumes the findings produced by an active Access Analyzer and reports on them.

-   **Goal:** To detect and flag any resources that Access Analyzer has marked as being accessible by an external entity.
-   **Data Source:** The plugin uses data collected from the `accessanalyzer:ListFindings` AWS API call for each analyzer.
-   **Analysis Logic:** The plugin iterates through all findings for an analyzer. It specifically looks for findings where the `status` attribute is set to `ACTIVE`. Any such finding indicates a current, unresolved issue that requires attention.

### Logic Flowchart

```mermaid
graph TD
    A(Start) --> B{Run `ListFindings` for analyzer};
    B --> C{Any findings returned?};
    C -- No --> H[Generate OK: "No findings found"];
    C -- Yes --> D{Loop through each finding};
    D --> E{Finding status == 'ACTIVE'?};
    E -- Yes --> F[Generate FAIL: "Active finding detected for [resource]"];
    F --> D
    E -- No --> G(Ignore finding and continue);
    G --> D
    D -- All findings processed --> H;
    H --> I(End);
```

### Example Failure Finding

If an S3 bucket is found to be publicly accessible, the plugin will generate a finding similar to this:

```json
{
  "status": 2,
  "message": "Access Analyzer has an active finding with type: External Access for resource which is publicly accessible.",
  "region": "us-east-1",
  "resource": "arn:aws:s3:::my-public-test-bucket"
}
```

## Comprehensive Access Analyzer Finding Attributes

When a finding is generated by AWS Access Analyzer, it contains a rich set of attributes that describe the potential issue. The CloudSploit plugins use these attributes, primarily `status` and `resource`, to create their reports. The following table lists the key attributes available within a finding object returned by the AWS API.

| Attribute | Type | Description |
|---|---|---|
| `id` | String | The unique ID for the finding. |
| `principal` | Map | The external entity that has been granted access. This can be an AWS account, a canonical user, or other principals. |
| `action` | Array | A list of actions (e.g., `s3:GetObject`, `sts:AssumeRole`) that the external entity is permitted to perform. |
| `resource` | String | The ARN of the resource that is accessible. |
| `isPublic` | Boolean | If `true`, the resource is accessible to the public (unauthenticated users). |
| `resourceType` | String | The type of the resource (e.g., `AWS::S3::Bucket`, `AWS::IAM::Role`). |
| `condition` | Map | The set of conditions from the policy statement that must be met for the access to be allowed. |
| `status` | String | The current status of the finding. CloudSploit specifically looks for `ACTIVE`. Other values are `ARCHIVED` and `RESOLVED`. |
| `createdAt` | Timestamp | The timestamp of when the finding was originally created. |
| `analyzedAt` | Timestamp | The timestamp of when the resource was last analyzed. |
| `updatedAt` | Timestamp | The timestamp of when the finding status was last updated. |
| `error` | String | If an error occurred during analysis, this field provides details. |
| `sources` | Array | The policy or ACL that led to the finding. |
